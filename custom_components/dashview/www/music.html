<div class="music-tab-container media-container">
    <div class="music-tab-header">
        <div class="music-room-tabs" id="music-room-tabs">
            </div>
    </div>
    
    <div class="music-tab-content" id="music-tab-content">
        </div>
</div>

<style>
.music-tab-container {
    padding: 20px;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
}

.music-tab-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* NEW: Styles for text-based room tabs, inspired by the weather card */
.music-room-tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
}

.music-tab-button {
    padding: 8px 16px;
    background-color: var(--gray100);
    border: none;
    border-radius: 16px;
    cursor: pointer;
    font-size: 0.9em;
    font-family: var(--primary-font-family);
    color: var(--secondary-text-color);
    transition: all 0.2s ease;
}

.music-tab-button.active {
    background: var(--active-big);
    color: var(--gray000);
    font-weight: 500;
}

.music-tab-content {
    display: block;
}

.music-room-content {
    display: none;
}

.music-room-content.active {
    display: block;
}
</style>

<script>
// Dynamic Music Tab Management with Configuration Integration
(function() {
    'use strict';
    
    let musicRooms = [];
    let activeTabId = null;
    
    function loadMusicRoomsFromConfig() {
        const dashviewPanel = document.querySelector('dashview-panel');
        if (dashviewPanel && dashviewPanel._houseConfig && dashviewPanel._houseConfig.rooms) {
            const rooms = dashviewPanel._houseConfig.rooms;
            musicRooms = Object.entries(rooms)
                .filter(([roomId, roomConfig]) => roomConfig.media_players && roomConfig.media_players.length > 0)
                .map(([roomId, roomConfig]) => ({
                    id: roomId,
                    name: roomConfig.friendly_name || roomId,
                    mediaPlayers: roomConfig.media_players
                }));

            if (musicRooms.length === 0) {
                const musicContainer = document.querySelector('.music-tab-container');
                if (musicContainer) {
                    musicContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--gray800);"><p>No music players are defined yet. Please configure them in the admin panel.</p></div>';
                }
                return false;
            }
            return true;
        }
        return false;
    }
    
    async function updateTabsForConfiguration() {
        const tabContainer = document.getElementById('music-room-tabs');
        const contentContainer = document.getElementById('music-tab-content');
        const dashviewPanel = document.querySelector('dashview-panel');
        
        if (!tabContainer || !contentContainer || !dashviewPanel) {
            return;
        }
        
        tabContainer.innerHTML = '';
        contentContainer.innerHTML = '';
        
        const cardTemplate = await fetch('/local/dashview/templates/room-media-player-card.html').then(res => res.text());

        musicRooms.forEach((room, index) => {
            const tabButton = document.createElement('button');
            tabButton.className = `music-tab-button ${index === 0 ? 'active' : ''}`;
            tabButton.dataset.roomId = room.id;
            tabButton.textContent = room.name;
            tabContainer.appendChild(tabButton);
            
            const roomContent = document.createElement('div');
            roomContent.className = `music-room-content ${index === 0 ? 'active' : ''}`;
            roomContent.dataset.roomId = room.id;
            roomContent.innerHTML = cardTemplate;
            contentContainer.appendChild(roomContent);
            
            // Initialize the card
            if (dashviewPanel._mediaPlayerManager) {
                dashviewPanel._mediaPlayerManager.initialize(roomContent, room.id, room.mediaPlayers);
            }
        });
        
        if (musicRooms.length > 0) {
            activeTabId = musicRooms[0].id;
        }
        
        setupTabSwitching();
    }
    
    function setupTabSwitching() {
        const tabButtons = document.querySelectorAll('.music-tab-button');
        const roomContents = document.querySelectorAll('.music-room-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const roomId = this.dataset.roomId;
                activeTabId = roomId;
                
                tabButtons.forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                
                roomContents.forEach(content => {
                    content.classList.toggle('active', content.dataset.roomId === roomId);
                });
            });
        });
    }
    
    function initMusicTabs() {
        if (loadMusicRoomsFromConfig()) {
            updateTabsForConfiguration();
        } else {
            setTimeout(initMusicTabs, 500); // Retry if config not ready
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMusicTabs);
    } else {
        initMusicTabs();
    }
})();
</script>
